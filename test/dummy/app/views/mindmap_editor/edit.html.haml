!!!5
%html
  %head
    %meta{charset: 'utf-8'}
    %meta{name: 'viewport', content: 'width=device-width, initial-scale=1'}
    %title Jinda Mindmap Editor
    = csrf_meta_tags
    %link{rel: 'stylesheet', href: 'https://unpkg.com/jsmind@0.5.2/style/jsmind.css'}
    :css
      body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
      h1 { margin: 0 0 20px 0; }
      .controls { margin-bottom: 20px; }
      #jsmind_container { 
        width: 100%; 
        height: 70vh; 
        border: 1px solid #ccc; 
        border-radius: 4px;
        background: #f9f9f9;
      }
      .btn { 
        padding: 10px 20px; 
        margin-right: 10px;
        background: #4CAF50; 
        color: white; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 14px;
      }
      .btn:hover { background: #45a049; }
      .btn-secondary { background: #008CBA; }
      .btn-secondary:hover { background: #007399; }
      #status { padding: 10px; margin-top: 10px; border-radius: 4px; }
      .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
      .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  %body
    %h1 Jinda Mindmap Editor
    
    .controls
      %button.btn#save_button{type: 'button'} Save & Update
      %button.btn.btn-secondary#reload_button{type: 'button'} Reload
      %span{style: 'margin-left: 20px; color: #666;'} Double-click nodes to edit | Right-click for options
    
    #jsmind_container
    
    #status

    %script{src: 'https://unpkg.com/jsmind@0.5.2/js/jsmind.js'}
    :javascript
      var jm = null;
      var originalData = #{raw @mind_data.to_json};
      
      window.addEventListener('load', function() {
        console.log('jsMind loaded:', typeof jsMind !== 'undefined');
        console.log('Mind data:', originalData);
        
        if (typeof jsMind === 'undefined') {
          document.getElementById('jsmind_container').innerHTML = 
            '<div style="padding: 20px; color: red;">Error: jsMind library failed to load</div>';
          return;
        }
        
        // Initialize jsMind
        var options = {
          container: 'jsmind_container',
          theme: 'primary',
          editable: true,
          mode: 'full'
        };
        
        jm = new jsMind(options);
        jm.show(originalData);
        
        // Save button handler
        document.getElementById('save_button').addEventListener('click', function() {
          var button = this;
          button.disabled = true;
          button.textContent = 'Saving...';
          
          var data = jm.get_data();
          console.log('Saving data:', data);
          
          fetch('#{mindmap_editor_save_path}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ mind_data: data })
          })
          .then(response => response.json())
          .then(result => {
            button.disabled = false;
            button.textContent = 'Save & Update';
            
            var status = document.getElementById('status');
            if (result.success) {
              status.className = 'success';
              status.innerHTML = '<strong>Success!</strong> ' + result.message;
              if (result.output) {
                status.innerHTML += '<br><small>Output: ' + result.output.substring(0, 200) + '...</small>';
              }
            } else {
              status.className = 'error';
              status.innerHTML = '<strong>Error:</strong> ' + result.error;
            }
            
            setTimeout(() => { status.innerHTML = ''; status.className = ''; }, 5000);
          })
          .catch(error => {
            button.disabled = false;
            button.textContent = 'Save & Update';
            
            var status = document.getElementById('status');
            status.className = 'error';
            status.innerHTML = '<strong>Error:</strong> ' + error.message;
          });
        });
        
        // Reload button handler
        document.getElementById('reload_button').addEventListener('click', function() {
          if (confirm('Reload mindmap? Any unsaved changes will be lost.')) {
            location.reload();
          }
        });
      });
