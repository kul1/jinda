name: CI

on:
  push:
    branches: [ main, develop, 'jinda-*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27888:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Read Ruby version from gemspec
      id: ruby-version
      run: |
        RUBY_VERSION=$(grep 'required_ruby_version' jinda.gemspec | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
        echo "version=$RUBY_VERSION" >> $GITHUB_OUTPUT
        echo "Ruby version from gemspec: $RUBY_VERSION"
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ steps.ruby-version.outputs.version }}
        bundler-cache: false
    
    - name: Read Rails version from gemspec
      id: rails-version
      run: |
        RAILS_VERSION=$(grep "add_runtime_dependency 'rails'" jinda.gemspec | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
        echo "version=$RAILS_VERSION" >> $GITHUB_OUTPUT
        echo "Rails version from gemspec: $RAILS_VERSION"
    
    - name: Install Rails
      run: gem install rails -v "~> ${{ steps.rails-version.outputs.version }}"
    
    - name: Install dependencies
      run: |
        gem install bundler
        gem install minitest-reporters
        gem install rake
    
    - name: Display versions
      run: |
        echo "Ruby: $(ruby -v)"
        echo "Rails: $(rails -v)"
        echo "Bundler: $(bundle -v)"
        echo "Rake: $(rake --version)"
    
    - name: Run installation tests
      env:
        MONGODB_PORT: 27888
        SKIP_CLEANUP: false
      run: |
        rake test
    
    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-app-ruby-${{ steps.ruby-version.outputs.version }}-rails-${{ steps.rails-version.outputs.version }}
        path: ~/tmp/jinda_tests/
        retention-days: 7
