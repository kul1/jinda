#!/usr/bin/env ruby
require "timeout"

modified = `git status --porcelain`.lines.filter_map { |l| l.split.last }.uniq
files    = modified.select { |p| p.end_with?(".rb") }

if files.empty?
  puts "No modified Ruby files."
  exit 0
end

files.each do |file|
  puts "RuboCop: #{file}"
  begin
    Timeout.timeout(30) do
      system("rubocop", "--config", File.expand_path("~/.rubocop.yml"), "-A", file)
    end
  rescue Timeout::Error
    puts "Timeout on #{file} (over 30s). Skipping; fix manually."
  end
end
